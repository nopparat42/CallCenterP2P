<script>
  let otpCode = "";
  let isOtpVerified = false;

  function sendOTP() {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) return alert("กรุณากรอกเบอร์โทร");

    otpCode = Math.floor(100000 + Math.random() * 900000).toString(); // mock OTP
    alert("OTP ของคุณคือ: " + otpCode);
    isOtpVerified = false; // reset เมื่อส่ง OTP ใหม่
  }

  function verifyOTP() {
    const inputOtp = document.getElementById("otp").value.trim();
    if (inputOtp === otpCode) {
      alert("ยืนยัน OTP สำเร็จ");
      isOtpVerified = true;
      loadVendors(); // โหลด vendor หลัง OTP ถูกต้อง
    } else {
      alert("OTP ไม่ถูกต้อง");
      isOtpVerified = false;
    }
  }

  function loadVendors() {
    if (!isOtpVerified) {
      alert("กรุณายืนยัน OTP ก่อน");
      return;
    }

    const phone = document.getElementById("phone").value.trim();
    fetch(`https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?phone=${phone}`)
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById("vendor");
        select.innerHTML = '<option value="">-- เลือก Vendor --</option>';
        data.vendors.forEach(v => {
          const option = document.createElement("option");
          option.value = v;
          option.text = v;
          select.appendChild(option);
        });
      })
      .catch(err => {
        alert("ไม่สามารถโหลดรายชื่อ Vendor ได้: " + err);
      });
  }

  function showConsent() {
    const confirmed = confirm("คุณยินยอมให้เราใช้ข้อมูลของคุณหรือไม่?");
    document.getElementById("consent").checked = confirmed;
  }

  function registerUser() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const vendor = document.getElementById("vendor").value;
    const consentChecked = document.getElementById("consent").checked;

    if (!isOtpVerified) {
      alert("กรุณายืนยัน OTP ก่อนลงทะเบียน");
      return;
    }

    if (!username || !password || !email || !phone || !vendor) {
      alert("กรุณากรอกข้อมูลให้ครบทุกช่อง");
      return;
    }

    if (!consentChecked) {
      alert("กรุณายอมรับนโยบายก่อนลงทะเบียน");
      return;
    }

    const data = { username, password, email, phone, vendor };

    fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec", {
      method: "POST",
      body: JSON.stringify(data),
    })
      .then(res => res.json())
      .then(resp => {
        alert("ลงทะเบียนสำเร็จ!");
        window.close();
      })
      .catch(err => {
        alert("เกิดข้อผิดพลาด: " + err);
      });
  }
</script>
